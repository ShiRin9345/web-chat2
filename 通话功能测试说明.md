# 视频通话功能测试说明

## 修复的问题

1. **发起方加入房间** - 发起方在发送请求时现在会自动加入房间
2. **信令转发改进** - 后端信令转发添加了详细日志，便于调试
3. **前端日志增强** - 添加了详细的控制台日志，可以追踪整个 WebRTC 连接过程

## 测试步骤

### 准备工作
1. 启动项目：`pnpm dev`
2. 打开两个浏览器窗口（或使用无痕模式）
3. 分别登录两个不同的用户账号
4. 确保两个用户已经是好友关系

### 测试视频通话

#### 用户 A（发起方）：
1. 打开与用户 B 的聊天页面
2. 确认用户 B 在线（在线状态显示为绿点）
3. 点击顶部的 **Video 图标**（视频通话按钮）
4. 应该看到通话界面，显示 "呼叫中..."
5. **打开浏览器控制台**，查看日志输出：
   ```
   初始化通话, isInitiator: true
   添加媒体轨道: video
   添加媒体轨道: audio
   发起方：发送通话请求
   ```

#### 用户 B（接收方）：
1. 应该自动弹出来电通知对话框
2. 显示用户 A 的头像、名称和 "视频通话呼叫中..."
3. 点击 **绿色的接听按钮**
4. **打开浏览器控制台**，查看日志输出：
   ```
   收到来电: {roomId, fromUserId, callType, recordId}
   初始化通话, isInitiator: false
   添加媒体轨道: video
   添加媒体轨道: audio
   接收方：发送接受信令
   收到 Offer: ...
   设置远程描述 (Offer)
   开始创建 Answer
   创建 Answer 成功
   设置本地描述成功
   发送 Answer 给好友: ...
   ```

#### 用户 A（发起方继续）：
1. 控制台应该显示：
   ```
   对方已接受通话，开始创建 Offer
   PeerConnection 状态: stable
   开始创建 Offer, PeerConnection 状态: stable
   创建 Offer 成功
   设置本地描述成功
   发送 Offer 给好友: ...
   收到 Answer: ...
   设置远程描述 (Answer)
   连接状态变化: connecting
   收到 ICE Candidate: ...
   连接状态变化: connected
   WebRTC 连接已建立
   ```

#### 双方：
1. 应该能看到对方的视频画面
2. 能听到对方的声音
3. 可以点击底部按钮控制：
   - **麦克风按钮**：静音/取消静音
   - **摄像头按钮**：关闭/开启视频
   - **红色挂断按钮**：结束通话
4. 顶部显示通话时长（连接后开始计时）

## 调试技巧

### 如果看不到对方视频：

1. **检查控制台日志**：
   - 查找错误信息
   - 确认 Offer/Answer 是否成功交换
   - 确认 ICE Candidate 是否收到

2. **检查浏览器权限**：
   - 确保允许访问摄像头和麦克风
   - Chrome: 设置 > 隐私和安全 > 网站设置 > 摄像头/麦克风

3. **检查后端日志**：
   打开终端，查看服务器日志：
   ```
   收到通话请求: ...
   转发 WebRTC Offer 给用户: ...
   Offer 已转发给: ...
   转发 WebRTC Answer 给用户: ...
   Answer 已转发给: ...
   转发 ICE Candidate 给用户: ...
   ```

4. **常见问题排查**：
   - 如果一直显示 "连接中..."：检查 ICE Candidate 是否正常交换
   - 如果显示 "连接失败"：检查网络设置，可能需要 TURN 服务器
   - 如果有本地视频但没有远程视频：检查 ontrack 事件是否触发

### 测试语音通话

步骤与视频通话相同，只需点击 **Phone 图标**（语音通话按钮）即可。

语音通话界面特点：
- 显示对方头像（不显示视频画面）
- 只有静音和挂断按钮（没有摄像头控制）

## 预期行为

### 正常流程：
1. 发起方点击通话 → 状态：calling
2. 接收方收到来电 → 显示来电对话框
3. 接收方接受 → 双方状态：connecting
4. WebRTC 建立连接 → 双方状态：connected
5. 显示远程视频流 → 开始计时
6. 任意一方挂断 → 状态：ended → 关闭对话框

### 异常处理：
- 对方不在线 → 提示 "对方当前不在线"
- 对方拒绝 → 提示 "对方已拒绝通话"
- 设备权限拒绝 → 提示 "无法访问摄像头或麦克风"
- 连接失败 → 提示 "连接失败，请检查网络"

## 数据库记录

通话结束后，可以在数据库中查看 `call_records` 表：
```sql
SELECT * FROM call_record ORDER BY created_at DESC LIMIT 5;
```

记录包含：
- roomId: 房间ID
- callerId: 发起人ID
- receiverId: 接收人ID
- callType: video/audio
- status: completed/missed/rejected/cancelled
- duration: 通话时长（秒）
- startedAt: 接通时间
- endedAt: 结束时间
- createdAt: 请求发起时间
